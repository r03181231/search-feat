<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <style></style>
  </head>
  <body>
    <h1>최고 평점 영화 콜렉션</h1>
    <h2>영화 검색 :</h2>
    <input type="text" id="input" placeholder="영화 제목을 검색해 보세요" />
    <button id="searchBtn" type="button">검색</button>
    <div id="cards-container"></div>

    <script type="module">
      //필수 요구사항 [1] jQuery 라이브러리 사용없이 순수 바닐라 자바스크립트 사용하기
      //필수 요구사항[2] TMDB 오픈 API를 이용하여 인기영화 데이터 가져오기
      const options = {
        method: "GET",
        headers: {
          accept: "application/json",
          Authorization:
            "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI4ZmYyZWNmMzg2NmU3NDI5Nzk5ODdmMWY4NWIxOGQxNyIsInN1YiI6IjY1OGVjZmUwOWYxYmU3Njg2NzgwY2I3YyIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.GCIqNf864_nSJFKca9jtRMZzbPuVE4F2TBjeQm1in5A",
        },
      };
      //브라우저가 켜진 후
      document.addEventListener("DOMContentLoaded", async (e) => {
        const $cardAll = document.getElementsByClassName("card-content");
        const url =
          "https://api.themoviedb.org/3/movie/top_rated?language=en-US&page=1";
        const $searchBtn = document.querySelector("#searchBtn");
        const $cards = document.querySelector("#cards-container");
        const $input = document.querySelector("#input");
        // 1. 영화정보 가져와서 담기
        const movies = await fetch(url, options)
          .then((res) => res.json())
          .then((res) => {
            const movie = res.results;
            return movie;
          })
          .catch((err) => console.error(err));
        //2-1. response값 꺼내기
        // console.log(movies);

        // 2-2. 화면에 보이기
        movies.forEach((mainCards, i) => {
          const $mainCardsDiv = document.createElement("div");
          // 2-3. 생성한 div에 클래스 붙여주기
          $mainCardsDiv.setAttribute("class", "card-content");
          $mainCardsDiv.innerHTML = `
                    <div id="${mainCards.id}" class="target">id : ${mainCards.id}</div>
                    <img src="https://image.tmdb.org/t/p/w500${mainCards.poster_path}" alt="${mainCards.title}">
                    <h3>제목 : ${mainCards.title}</h3>
                    <p>내용 요약 : ${mainCards.overview}</p>
                    <p class="Rating">평점 : ${mainCards.vote_average}</p>
                  `;

          return $cards.append($mainCardsDiv);
        });
        // =========================================================
        // 3. 검색 버튼을 클릭 시,
        $searchBtn.addEventListener("click", (e) => {
          const $cardAll = document.getElementsByClassName("card-content");
          // 4. 인풋에 적은 키워드 가져와서 담기
          const inputValue = $input.value;
          // 5. 검색어와 일치하는 정보 찾아내기
          const equalCardData = movies.filter((movie) => {
            return movie.title.includes(inputValue);
          });
          // 6. 이전 정보 비워주기 -incertAdjacentHTML("afterend", "");로 추후 수정해보기
          // innerHTML은 script문으로 공격하면 text로 dom정보를 다 가져와서 XXS공격에 취약
          $cards.innerHTML = "";

          // 7. 찾은 키워드에 대한 카드 정보를 채우기
          equalCardData.map((searchCard, i) => {
            const $searchCardDiv = document.createElement("div");
            $searchCardDiv.setAttribute("class", "card-content");
            $searchCardDiv.innerHTML = ` 
                    <div id="${searchCard.id}" class="target">id : ${searchCard.id}</div>
                    <img src="https://image.tmdb.org/t/p/w500${searchCard.poster_path}" alt="${searchCard.title}">
                    <h3>제목 : ${searchCard.title}</h3>
                    <p>내용 요약 : ${searchCard.overview}</p>
                    <p class="Rating">평점 : ${searchCard.vote_average}</p>
                  `;

            return $cards.append($searchCardDiv);
          });

          //전체카드 중에서
          movieIdAlert("영화 id", $cardAll);
        });
        //카드 클릭 시, 클릭한 영화카드 id값 alert창에 띄우기
        movieIdAlert("영화 id", $cardAll);
      });
    </script>
    <script src="./js/alert.js"></script>
  </body>
</html>
