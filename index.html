<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./css/reset.css" />
    <link rel="stylesheet" href="./css/main.css" />
  </head>
  <body>
    <div class="layout-1280">
      <header>
        <h1>최고 평점 영화 콜렉션</h1>
        <div class="titleNsearch">
          <h2>영화 검색</h2>
          <div class="inputNsearchBtn">
            <input
              type="text"
              id="input"
              placeholder="영화 제목을 검색해 보세요"
            />
            <div class="searchBtnWrap">
              <button id="searchBtn" type="button">검색</button>
            </div>
          </div>
        </div>
      </header>
      <main>
        <div id="cards-container" class="cardContainer"></div>
      </main>
      <footer>
        <div>
          <p>Designed by <span>남해리 in 빼빼로와 아이들, 11조</span></p>
        </div>
        <div>
          <p>copyright. 남해리</p>
        </div>
      </footer>
    </div>

    <script>
      //필수요구[1] - jQuery 라이브러리 사용없이 순수 바닐라 자바스크립트 사용하기
      //필수요구[2] - TMDB 오픈 API를 이용하여 인기영화 데이터 가져오기
      const options = {
        method: "GET",
        headers: {
          accept: "application/json",
          Authorization:
            "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI4ZmYyZWNmMzg2NmU3NDI5Nzk5ODdmMWY4NWIxOGQxNyIsInN1YiI6IjY1OGVjZmUwOWYxYmU3Njg2NzgwY2I3YyIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.GCIqNf864_nSJFKca9jtRMZzbPuVE4F2TBjeQm1in5A",
        },
      };

      //브라우저가 켜진 후
      document.addEventListener("DOMContentLoaded", async (e) => {
        const $cardAll = document.getElementsByClassName("card-content");
        const url =
          "https://api.themoviedb.org/3/movie/top_rated?language=en-US&page=1";
        const $searchBtn = document.querySelector("#searchBtn");
        const $cards = document.querySelector("#cards-container");
        const $input = document.querySelector("#input");
        const inputValue = $input.value;

        //선택사항 - 웹사이트 랜딩 또는 새로고침 후 input에 커서 자동 위치시키기
        $input.focus();
        // 1. 필수요구[2] - TMDB 오픈 API를 이용하여 인기영화 데이터 가져오기
        const movies = await fetch(url, options)
          .then((res) => res.json())
          .then((res) => {
            const movie = res.results;
            return movie;
          })
          .catch((err) => console.error(err));

        //2-1. response값 꺼내기
        // console.log(movies);

        // 2-2. 필수요구[3] - 영화정보 카드 리스트 UI 구현
        //필수요구[5] - 하기 기재된 Javascript 문법 요소를 이용하여 구현
        movies.map((mainCards, i) => {
          // 2-3. 생성한 div에 클래스 붙여주기
          const $mainCardsDiv = document.createElement("div");
          $mainCardsDiv.setAttribute("class", "card-content");
          $mainCardsDiv.setAttribute("movieId", mainCards.id);
          //div로 따로 놀던 div들을 묶어서 하나의 카드를 클릭했을 때 어딜 클릭해도 나오게끔
          $mainCardsDiv.innerHTML = `
                  <div id="${mainCards.id}" class="card-wrap">
                    <div class="target">id : ${mainCards.id}</div>
                    <div class="imgSort">
                       <img
                         src="https://image.tmdb.org/t/p/w500${mainCards.poster_path}"
                         alt="${mainCards.title}"
                       />
                    </div>                    <h3>제목 : ${mainCards.title}</h3>
                    <p>내용 요약 : ${mainCards.overview}</p>
                    <p class="Rating">평점 : ${mainCards.vote_average}</p>
                  </div>
                  `;

          return $cards.append($mainCardsDiv);
        });
        // const $cardsEach = document.querySelector("#card-content");
        // console.log($cardsEach);
        $cards.addEventListener("click", (e) => {
          //card-container
          // console.log(e.target.closest(".card-content"));
          if (e.target.closest(".card-content") !== null) {
            const targetCardId = e.target
              .closest(".card-content")
              .querySelector("div").id;
            //targetCardId
            if (targetCardId) {
              window.alert("영화 id : " + targetCardId);
            }
          }
        });

        //검색 기능 함수=========================================================
        //3. 검색 버튼을 클릭 시,필수요구[4] - 영화 검색 UI 구현
        const searchBtnClick = (e) => {
          const $cardAll = document.getElementsByClassName("card-content");
          // 4. 인풋에 적은 키워드 가져와서 담기
          const inputValue = $input.value;
          // 5-1. 검색어와 일치하는 정보 찾아내기
          // 필수요구[5] - 하기 기재된 Javascript 문법 요소를 이용하여 구현
          // 선택요구 - 대소문자 관계없이 검색 가능하게 하기
          const equalCardData = movies.filter((movie) => {
            const upperValue = inputValue.toUpperCase();
            return movie.title.toUpperCase().includes(upperValue);
          });
          // 6. 이전 정보 비워주기
          $cards.innerHTML = "";

          // 7. 찾은 키워드에 대한 카드 정보를 채우기
          //필수요구[5] - 하기 기재된 Javascript 문법 요소를 이용하여 구현
          equalCardData.map((searchCard, i) => {
            const $searchCardDiv = document.createElement("div");
            $searchCardDiv.setAttribute("class", "card-content");
            //  -incertAdjacentHTML("afterend", "");로 추후 수정해보기
            // innerHTML은 script문으로 공격하면 text로 dom정보를 다 가져와서 XXS공격에 취약
            $searchCardDiv.innerHTML = `
                  <div id="${searchCard.id}" class="card-wrap">
                    <div class="target">id : ${searchCard.id}</div>
                    <div class="imgSort">
                       <img
                         src="https://image.tmdb.org/t/p/w500${searchCard.poster_path}"
                         alt="${searchCard.title}"
                       />
                    </div>                     <h3>제목 : ${searchCard.title}</h3>
                    <p>내용 요약 : ${searchCard.overview}</p>
                    <p class="Rating">평점 : ${searchCard.vote_average}</p>
                </div>
                  `;

            return $cards.append($searchCardDiv);
          });
          // 필수요구[3] - 영화정보 카드 리스트 UI 구현 -카드 클릭 시에는 클릭한 영화 id 를 나타내는 alert 창을 띄웁니다.
          // movieIdAlert("영화 id", $cardAll);
        };
        // 선택요구 - 키보드 enter키를 입력해도 검색버튼 클릭한 것과 동일하게 검색 실행시키기
        $input.addEventListener("keyup", (key) => {
          if (key.keyCode === 13) {
            searchBtnClick();
          }
        });
        $searchBtn.addEventListener("click", searchBtnClick);
        //===================여기까지 검색
        // const $cardTarget = document.getElementsByClassName("card-wrap");

        // console.log($cardTarget);

        // 필수요구[3] - 영화정보 카드 리스트 UI 구현 -카드 클릭 시에는 클릭한 영화 id 를 나타내는 alert 창을 띄웁니다.
        // for (let i = 0; i < $cardTarget.length; i++) {
        //   console.log($cardTarget[i]);
        //   //카드 하나 클릭 시,
        //   $cardTarget[i].addEventListener("click", async (e) => {
        //     let onetargetCardId = event.target.id;
        //     // console.log(onetargetCardId);
        //     window.alert(`영화 id : ${onetargetCardId}`);
        //   });
        // }
      });
    </script>
  </body>
</html>
